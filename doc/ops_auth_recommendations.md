# 운영/배치 환경 BigQuery 인증 권장안(요약)

이 문서는 `google-cloud-bigquery`(Python Client)를 사용하는 스크립트를 **회사 운영/배치 환경**에 적용할 때, 인증 방식을 어떻게 선택하는 것이 좋은지 정리합니다.

## 1) 결론(권장 순서)

- 개발자 PC: `gcloud auth application-default login`(ADC) 사용 가능(편의)
- 운영/배치/CI: **개인 계정 ADC는 지양(권장)** → **서비스계정 기반**으로 분리
- 서비스계정은 가능하면 **키 파일(JSON) 없이** 운영(= 유출 리스크 최소화)

## 2) 왜 개인 ADC를 운영에 쓰면 안 좋은가

- 사람(개인 계정)에 종속되어 권한/퇴사/잠금 정책 변화에 취약
- 운영 장애 시 계정 잠김/만료 등으로 원인 파악이 어려워질 수 있음

## 3) 운영 인증 옵션 3종

### 옵션 A) GCP 런타임에서 “서비스계정 부여”(가장 단순 + 권장)

다음 환경에서 스크립트를 실행한다면, 런타임 리소스에 서비스계정을 붙이고 **키 파일 없이 ADC 자동 획득**이 가능합니다.

- Compute Engine VM
- GKE Workload Identity
- Cloud Run
- Cloud Functions

장점
- 키 파일 불필요(유출 위험 최소)
- 운영 표준/자동화에 적합

필수
- 런타임에 연결할 서비스계정 생성
- 최소권한 역할 부여(아래 참고)

### 옵션 B) 온프렘/사내 서버: Workload Identity Federation(WIF) (권장)

GCP 외부(온프렘/사내 VM/서버)에서 실행해야 한다면, 가능하면 JSON 키 대신 **WIF로 단기 토큰**을 발급하는 구성이 안전합니다.

장점
- 장기 키 파일 없이 운영 가능
- 토큰 수명이 짧아 유출 영향이 제한적

비고
- 조직 보안/IDP 및 GCP IAM 설정이 필요해서 초기 셋업이 다소 복잡할 수 있습니다.

### 옵션 C) 서비스계정 키(JSON) 파일 (최후의 수단)

불가피할 때만 사용합니다.

장점
- 구성/운영이 단순

리스크(중요)
- 키 유출 시 심각한 사고로 이어질 수 있음

권장 통제
- 키는 Git 저장소에 절대 커밋 금지
- 파일 권한 최소화(소유자만 읽기)
- Secret Manager/사내 Vault 등으로 관리
- 주기적 로테이션/폐기 프로세스 마련

## 4) 최소 권한(Least Privilege) 예시

실행이 “쿼리 실행(job 생성)” 중심이면 일반적으로 아래 조합이 출발점입니다.

- 프로젝트 레벨: `roles/bigquery.jobUser`
- 데이터 접근은 데이터셋 단위로 별도 부여
  - 읽기: `roles/bigquery.dataViewer`
  - 쓰기/적재: 필요 권한을 데이터셋 단위로 추가

주의
- 실제 권한은 SQL이 하는 작업(읽기/쓰기/DDL)에 따라 달라집니다.

## 5) 운영 체크리스트(짧게)

- [ ] 운영 전용 서비스계정 사용(개인 계정 사용 지양)
- [ ] 키 파일 없이 운영 가능한지 먼저 검토(GCP 런타임 SA / WIF)
- [ ] 최소권한 부여 및 권한 범위(프로젝트 vs 데이터셋) 확인
- [ ] 로그/감사 정책 확인(누가 어떤 Job을 만들었는지)
